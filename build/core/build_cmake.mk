
CMAKE_BUILD_MAKEFILE:=$(OUT_DEVICE_OBJ_DIR)/$(LOCAL_PATH)/Makefile

LOCAL_MODULE_BUILD=$(LOCAL_MODULE)
LOCAL_MODULE_STAMP := $(dir $(CMAKE_BUILD_MAKEFILE)).stampinstall

include $(BUILD_SYSTEM)/module_install.mk
ifneq (x$(LOCAL_FILTER_MODULE),x)
ALL_MODULES += $(LOCAL_FILTER_MODULE)
ALL_MODULES += $(LOCAL_DEPANNER_MODULES)
ALL_BUILD_MODULES += $(LOCAL_MODULE_STAMP)
endif

LOCAL_MODULE_BUILD_FORCE:=$(LOCAL_MODULE)-FORCE
MMA_MODULES += $(LOCAL_MODULE_BUILD_FORCE)

MAKEPARAM=-j1
ifneq (x$(MAKE_JLEVEL),x)
	MAKEPARAM=-j$(MAKE_JLEVEL)
endif
$(LOCAL_MODULE_BUILD_FORCE):LOCAL_CMAKE_BUILD_MAKEFILE:=$(CMAKE_BUILD_MAKEFILE)
$(LOCAL_MODULE_BUILD_FORCE):$(LOCAL_MODULE)
	cd $(dir $(LOCAL_CMAKE_BUILD_MAKEFILE)) && make &&\
	make DESTDIR=$(TOP_DIR)/$(SYSROOT) install/fast &&\
	make DESTDIR=$(TOP_DIR)/$(TARGET_FS_BUILD) install/fast && \
	cd -

$(LOCAL_MODULE_BUILD_FORCE)-clean:$(LOCAL_MODULE)-clean
$(LOCAL_MODULE):rootfs
$(LOCAL_MODULE):LOCAL_CMAKE_PATH:=$(CMAKE_PATH)
$(LOCAL_MODULE):LOCAL_CMAKE_CONF_OPTS:=$(CMAKE_CONF_OPTS)
$(LOCAL_MODULE):$(LOCAL_MODULE_STAMP)
$(LOCAL_MODULE_STAMP):$(LOCAL_DEPANNER_MODULES)


$(LOCAL_MODULE_STAMP):$(CMAKE_BUILD_MAKEFILE)
	cd $(dir $<) && make $(MAKEPARAM) &&\
	make DESTDIR=$(TOP_DIR)/$(SYSROOT) install/fast &&\
	make DESTDIR=$(TOP_DIR)/$(TARGET_FS_BUILD) install/fast && \
	cd -
	$(hide)install -D /dev/null $@


$(LOCAL_MODULE)-clean:LOCAL_CMAKE_BUILD_MAKEFILE:=$(CMAKE_BUILD_MAKEFILE)
$(LOCAL_MODULE)-clean:
	rm -rf $(dir $(LOCAL_CMAKE_BUILD_MAKEFILE))

$(CMAKE_BUILD_MAKEFILE):$(CMAKE_TEMPLATE)
	mkdir -p $(dir $@)
	rm -f CMakeCache.txt
	cd $(dir $@) && cmake $(TOP_DIR)/$(LOCAL_CMAKE_PATH) \
		-DCMAKE_TOOLCHAIN_FILE=$(TOP_DIR)/$(CMAKE_TEMPLATE) \
		-DCMAKE_INSTALL_PREFIX="/usr" \
		-DCMAKE_COLOR_MAKEFILE=OFF \
		-DBUILD_DOC=OFF \
		-DBUILD_DOCS=OFF \
		-DBUILD_EXAMPLE=OFF \
		-DBUILD_EXAMPLES=OFF \
		-DBUILD_TEST=OFF \
		-DBUILD_TESTS=OFF \
		-DBUILD_TESTING=OFF \
		-DBUILD_SHARED_LIBS=$(if $(LOCAL_STATIC_LIBS),OFF,ON) \
		$(LOCAL_CMAKE_CONF_OPTS) && cd -
